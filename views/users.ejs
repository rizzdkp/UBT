<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <title>User Management - Barcode Protocol</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#106EBE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Barcode Protocol">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.svg">
    
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/mobile-responsive.css" />
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ‘¥ User Management</h1>
            <div class="user">
                Logged in as <strong><%= user.full_name %></strong> (<%= user.role %>) â€” 
                <a href="/">Dashboard</a> | 
                <a href="/logout">Logout</a>
            </div>
        </header>

        <!-- Add New User Section (Admin Only) -->
        <% if (user.role === 'admin') { %>
        <section>
            <h2>Add New User</h2>
            <form method="post" action="/users" class="user-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" name="username" required />
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" name="full_name" required />
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select name="role" required>
                            <option value="viewer">Viewer - Read only access</option>
                            <option value="operator">Operator - Can create & update protocols</option>
                            <option value="admin">Admin - Full system access</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" name="password" required minlength="6" />
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" name="confirm_password" required minlength="6" />
                    </div>
                </div>
                <button type="submit" class="btn-primary">Create User</button>
            </form>
        </section>
        <% } %>

        <!-- Users List -->
        <section>
            <h2>System Users</h2>
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(function(u) { %>
                        <tr class="<%= u.is_active ? '' : 'inactive-user' %>">
                            <td><%= u.id %></td>
                            <td><strong><%= u.username %></strong></td>
                            <td><%= u.full_name %></td>
                            <td><%= u.email %></td>
                            <td>
                                <span class="role-badge role-<%= u.role %>">
                                    <%= u.role.toUpperCase() %>
                                </span>
                            </td>
                            <td>
                                <span class="status-badge <%= u.is_active ? 'status-active' : 'status-inactive' %>">
                                    <%= u.is_active ? 'Active' : 'Inactive' %>
                                </span>
                            </td>
                            <td>
                                <%= u.last_login ? new Date(u.last_login).toLocaleString('id-ID') : 'Never' %>
                            </td>
                            <td>
                                <%= new Date(u.created_at).toLocaleString('id-ID', { dateStyle: 'short' }) %>
                            </td>
                            <td class="actions-cell">
                                <% if (user.role === 'admin' && u.id !== user.id) { %>
                                    <form method="post" action="/users/<%= u.id %>/toggle-status" style="display: inline;">
                                        <button type="submit" class="btn-sm <%= u.is_active ? 'btn-warning' : 'btn-success' %>">
                                            <%= u.is_active ? 'Deactivate' : 'Activate' %>
                                        </button>
                                    </form>
                                    <form method="post" action="/users/<%= u.id %>/reset-password" style="display: inline;">
                                        <button type="submit" class="btn-sm btn-info">Reset Pass</button>
                                    </form>
                                <% } %>
                                <a href="/users/<%= u.id %>/activity" class="btn-sm btn-secondary">Activity</a>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Activity Summary -->
        <section>
            <h2>Recent Activity</h2>
            <div class="activity-list">
                <% recentActivity.forEach(function(activity) { %>
                <div class="activity-item">
                    <div class="activity-header">
                        <strong><%= activity.username %></strong>
                        <span class="activity-action"><%= activity.action %></span>
                        <span class="activity-time">
                            <%= new Date(activity.created_at).toLocaleString('id-ID') %>
                        </span>
                    </div>
                    <div class="activity-details">
                        <% if (activity.target_type) { %>
                            Target: <%= activity.target_type %>
                            <% if (activity.target_id) { %>
                                (<%= activity.target_id %>)
                            <% } %>
                        <% } %>
                        <% if (activity.details) { %>
                            - <%= activity.details %>
                        <% } %>
                    </div>
                </div>
                <% }) %>
            </div>
        </section>
    </div>

    <script>
        // Form validation
        document.querySelector('.user-form').addEventListener('submit', function(e) {
            const password = document.querySelector('input[name="password"]').value;
            const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                alert('Passwords do not match!');
                return false;
            }
            
            if (password.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long!');
                return false;
            }
        });
    </script>
</body>
</html>