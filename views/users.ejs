<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <title>User Management - Barcode Protocol</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#106EBE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Barcode Protocol">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.svg">
    
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/mobile-responsive.css" />
    <link rel="stylesheet" href="/toast.css" />
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #106EBE;
        }
        
        .modal-content p {
            margin-bottom: 20px;
            color: #555;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* Activity List Styles */
        .activity-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .activity-item {
            background: #f8f9fa;
            border-left: 4px solid #106EBE;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .activity-header {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .activity-header strong {
            color: #106EBE;
            min-width: 120px;
        }
        
        .activity-action {
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #495057;
        }
        
        .activity-time {
            margin-left: auto;
            font-size: 12px;
            color: #6c757d;
        }
        
        .activity-details {
            font-size: 13px;
            color: #666;
            padding-left: 5px;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .activity-header {
                flex-wrap: wrap;
            }
            
            .activity-time {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üë• User Management</h1>
            <div class="user">
                Logged in as <strong><%= user.full_name %></strong> (<%= user.role %>) ‚Äî 
                <a href="/">Dashboard</a> | 
                <a href="/logout">Logout</a>
            </div>
        </header>

        <!-- Add New User Section (Admin Only) -->
        <% if (user.role === 'admin') { %>
        <section>
            <h2>Add New User</h2>
            <form method="post" action="/users" class="user-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" name="username" required />
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" name="full_name" required />
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select name="role" required>
                            <option value="operator">Operator - Manage protocols & partners</option>
                            <option value="distribusi">Distribusi - Scanner & delivery only</option>
                            <option value="admin">Admin - Full system access</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" name="password" required minlength="6" />
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" name="confirm_password" required minlength="6" />
                    </div>
                </div>
                <button type="submit" class="btn-primary">Create User</button>
            </form>
        </section>
        <% } %>

        <!-- Users List -->
        <section>
            <h2>System Users</h2>
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(function(u) { %>
                        <tr class="<%= u.is_active ? '' : 'inactive-user' %>">
                            <td><%= u.id %></td>
                            <td><strong><%= u.username %></strong></td>
                            <td><%= u.full_name %></td>
                            <td><%= u.email %></td>
                            <td>
                                <span class="role-badge role-<%= u.role %>">
                                    <%= u.role.toUpperCase() %>
                                </span>
                            </td>
                            <td>
                                <span class="status-badge <%= u.is_active ? 'status-active' : 'status-inactive' %>">
                                    <%= u.is_active ? 'Active' : 'Inactive' %>
                                </span>
                            </td>
                            <td>
                                <%= u.last_login ? new Date(u.last_login).toLocaleString('id-ID') : 'Never' %>
                            </td>
                            <td>
                                <%= new Date(u.created_at).toLocaleString('id-ID', { dateStyle: 'short' }) %>
                            </td>
                            <td class="actions-cell">
                                <% if (user.role === 'admin' && u.id !== user.id) { %>
                                    <button type="button" 
                                            onclick="toggleUserStatus(<%= u.id %>, <%= u.is_active %>)" 
                                            class="btn-sm <%= u.is_active ? 'btn-warning' : 'btn-success' %>">
                                        <%= u.is_active ? 'DEACTIVATE' : 'ACTIVATE' %>
                                    </button>
                                    <button type="button" 
                                            onclick="showResetPasswordModal(<%= u.id %>, '<%= u.username %>')" 
                                            class="btn-sm btn-info">
                                        RESET PASS
                                    </button>
                                <% } %>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Reset Password Modal -->
        <div id="resetPasswordModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="modal-close" onclick="closeResetPasswordModal()">&times;</span>
                <h3>üîë Reset Password</h3>
                <p>Set new password for user: <strong id="resetUsername"></strong></p>
                <form id="resetPasswordForm" onsubmit="submitResetPassword(event)">
                    <input type="hidden" id="resetUserId" />
                    <div class="form-group">
                        <label>New Password *</label>
                        <input type="password" id="newPassword" required minlength="6" placeholder="Enter new password (min 6 characters)" />
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password *</label>
                        <input type="password" id="confirmNewPassword" required minlength="6" placeholder="Confirm new password" />
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeResetPasswordModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Reset Password</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Activity Summary -->
        <section>
            <h2>üìã Recent Activity</h2>
            <div class="activity-list">
                <% recentActivity.forEach(function(activity) { %>
                <div class="activity-item">
                    <div class="activity-header">
                        <strong><%= activity.username %></strong>
                        <span class="activity-action"><%= activity.action %></span>
                        <span class="activity-time">
                            <%= new Date(activity.created_at).toLocaleString('id-ID') %>
                        </span>
                    </div>
                    <div class="activity-details">
                        <% if (activity.target_type) { %>
                            Target: <%= activity.target_type %>
                            <% if (activity.target_id) { %>
                                (<%= activity.target_id %>)
                            <% } %>
                        <% } %>
                        <% if (activity.details) { %>
                            - <%= activity.details %>
                        <% } %>
                    </div>
                </div>
                <% }) %>
            </div>
        </section>
    </div>

    <script>
        // Form validation for new user
        const userForm = document.querySelector('.user-form');
        if (userForm) {
            userForm.addEventListener('submit', function(e) {
                const password = document.querySelector('input[name="password"]').value;
                const confirmPassword = document.querySelector('input[name="confirm_password"]').value;
                
                if (password !== confirmPassword) {
                    e.preventDefault();
                    alert('Passwords do not match!');
                    return false;
                }
                
                if (password.length < 6) {
                    e.preventDefault();
                    alert('Password must be at least 6 characters long!');
                    return false;
                }
            });
        }
        
        // Show Reset Password Modal
        function showResetPasswordModal(userId, username) {
            document.getElementById('resetUserId').value = userId;
            document.getElementById('resetUsername').textContent = username;
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('resetPasswordModal').style.display = 'flex';
        }
        
        // Close Reset Password Modal
        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }
        
        // Submit Reset Password
        function submitResetPassword(event) {
            event.preventDefault();
            
            const userId = document.getElementById('resetUserId').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return false;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return false;
            }
            
            // Send reset password request
            fetch(`/users/${userId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ newPassword: newPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Password reset successfully!');
                    closeResetPasswordModal();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to reset password'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error resetting password. Please try again.');
            });
        }
        
        // Toggle User Status
        function toggleUserStatus(userId, isActive) {
            const action = isActive ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} this user?`)) {
                return;
            }
            
            fetch(`/users/${userId}/toggle-status`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ User ${action}d successfully!`);
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to update user status'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error updating user status. Please try again.');
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('resetPasswordModal');
            if (event.target === modal) {
                closeResetPasswordModal();
            }
        }
    </script>
    <script src="/toast.js"></script>
</body>
</html>