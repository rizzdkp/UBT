<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0" />
  <title>Dashboard Mitra</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#E91E63">
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/mobile-responsive.css" />
  <link rel="stylesheet" href="/toast.css" />
  <style>
    .mitra-header-badge { background: var(--gradient-primary); color:#fff; padding:4px 10px; border-radius:20px; font-size:12px; font-weight:700; letter-spacing:.5px; }
    .partners-stats { display:flex; gap:15px; flex-wrap:wrap; margin-bottom:25px; }
    .partners-stats .stat-card { flex:1; min-width:150px; background:#fff; border:2px solid #F8BBD0; border-radius:12px; padding:18px 16px; position:relative; box-shadow:0 6px 16px rgba(233,30,99,.12); }
    .partners-stats .stat-card:before { content:''; position:absolute; inset:0; border-radius:10px; background:radial-gradient(circle at 30% 20%, rgba(233,30,99,.15), transparent 70%); pointer-events:none; }
    .partners-stats .stat-number { font-size:2rem; font-weight:700; color:#9C27B0; margin-bottom:4px; }
    .partners-stats .stat-label { font-size:12px; font-weight:600; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; }
    .partner-form { background:#fff; border:2px solid #F8BBD0; border-radius:12px; padding:22px 20px; margin-bottom:35px; box-shadow:0 8px 24px rgba(233,30,99,.08); }
    .partner-form h3 { margin:0 0 15px; font-size:1.2rem; font-weight:700; color:#7b1fa2; }
    .partners-table { width:100%; border-collapse:collapse; background:#fff; border:2px solid #F8BBD0; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(233,30,99,.12); }
    .partners-table th { background: var(--gradient-primary); color:#fff; padding:12px 14px; text-align:left; font-size:11px; letter-spacing:.5px; text-transform:uppercase; }
    .partners-table td { padding:12px 14px; border-bottom:1px solid #fce4ec; font-size:13px; }
    .partners-table tr:last-child td { border-bottom:none; }
    .type-badge { display:inline-block; padding:4px 8px; border-radius:12px; font-size:10px; font-weight:700; letter-spacing:.5px; background:#FCE4EC; color:#C2185B; }
    .status-badge { padding:4px 10px; border-radius:16px; font-size:10px; font-weight:700; letter-spacing:.5px; }
    .status-active { background:#c6f6d5; color:#276749; }
    .status-inactive { background:#fed7d7; color:#c53030; }
    .protocol-count { background:#E3F2FD; color:#1d4ed8; padding:4px 8px; border-radius:10px; font-size:11px; font-weight:700; }
    .btn-small { padding:4px 8px; font-size:11px; border:none; border-radius:6px; font-weight:700; cursor:pointer; }
    .btn-warning { background:#ed8936; color:#fff; }
    .btn-warning:hover { background:#dd6b20; }
    .btn-success { background:#48bb78; color:#fff; }
    .btn-success:hover { background:#38a169; }
    .btn-danger { background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; }
    .btn-danger:hover { background:linear-gradient(135deg,#dc2626,#b91c1c); }
    .no-data { text-align:center; padding:40px 20px; font-style:italic; color:#6b7280; }
    .mitra-actions-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; flex-wrap:wrap; gap:12px; }
    .search-box input { padding:10px 14px; border:2px solid #F8BBD0; border-radius:10px; width:220px; font-size:14px; }
    .search-box input:focus { outline:none; border-color:#E91E63; box-shadow:0 0 0 3px rgba(233,30,99,.2); }
    .filter-select { padding:10px 12px; border:2px solid #F8BBD0; border-radius:10px; background:#fff; font-size:14px; }
    .filter-select:focus { outline:none; border-color:#E91E63; box-shadow:0 0 0 3px rgba(233,30,99,.2); }
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:9999; align-items:center; justify-content:center; }
    .modal-overlay.show { display:flex; }
    .modal-content { background:#fff; border-radius:16px; padding:28px 24px; width:90%; max-width:600px; box-shadow:0 20px 60px rgba(0,0,0,.3); max-height:90vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:12px; border-bottom:2px solid #F8BBD0; }
    .modal-header h3 { margin:0; color:#7b1fa2; font-size:1.3rem; }
    .modal-close { background:none; border:none; font-size:24px; cursor:pointer; color:#9C27B0; padding:0 8px; }
    .modal-close:hover { color:#E91E63; }
    /* Icon buttons styling */
    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .btn-icon.btn-edit {
      background: linear-gradient(135deg, #B76E79, #884F5C);
      box-shadow: 0 2px 6px rgba(183, 110, 121, 0.3);
    }
    .btn-icon.btn-edit:hover {
      background: linear-gradient(135deg, #884F5C, #592F3E);
      box-shadow: 0 4px 12px rgba(183, 110, 121, 0.4);
      transform: translateY(-2px);
    }
    .btn-icon.btn-delete {
      background: linear-gradient(135deg, #592F3E, #080808);
      box-shadow: 0 2px 6px rgba(89, 47, 62, 0.3);
    }
    .btn-icon.btn-delete:hover {
      background: linear-gradient(135deg, #080808, #000000);
      box-shadow: 0 4px 12px rgba(89, 47, 62, 0.4);
      transform: translateY(-2px);
    }
    
    @media (max-width:760px){ 
      .partners-stats .stat-card{flex:1 1 calc(50% - 10px);} 
      .mitra-actions-bar{flex-direction:column; align-items:stretch;} 
      .search-box input{width:100%;} 
      .modal-content{width:95%; padding:20px 16px;} 
      .partners-table td:last-child { white-space: normal; min-width: auto; }
      .partners-table .btn-small { display: block; width: 100%; margin: 3px 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Dashboard Mitra <span class="mitra-header-badge">Mitra</span></h1>
      <div class="user">
        Masuk sebagai <strong><%= user.full_name || user %></strong>
        <% if (user.role) { %>(<%= user.role %>)<% } %> ‚Äî
        <a href="/">Dasbor</a> |
        <a href="/produsen">Produsen</a> |
        <% if (user.role === 'admin') { %><a href="/users">Pengguna</a> |<% } %>
        <a href="/logout">Keluar</a>
      </div>
    </header>

    <section class="partner-form">
      <h3>Tambah Mitra Baru</h3>
      <form method="post" action="/partners">
        <div class="form-row">
          <div class="form-group">
            <label>Nama Mitra</label>
            <input type="text" name="name" required placeholder="Nama lengkap mitra" />
          </div>
          <div class="form-group">
            <label>Jenis</label>
            <select name="type" required>
              <option value="">Pilih Jenis</option>
              <option value="klinik">Klinik</option>
              <option value="puskesmas">Puskesmas</option>
              <option value="rumah_sakit">Rumah Sakit</option>
            </select>
          </div>
          <div class="form-group">
            <label>Provinsi</label>
            <select name="province_code" required>
              <option value="">Pilih Provinsi</option>
              <% provinces.forEach(function(p){ %>
                <option value="<%= p.code %>"><%= p.name %> (<%= p.code %>)</option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Kode Mitra</label>
            <input type="text" name="code" required maxlength="10" placeholder="Misal: KLN001" />
          </div>
          <div class="form-group">
            <label>Telepon</label>
            <input type="tel" name="phone" placeholder="Nomor telepon" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" placeholder="Email kontak" />
          </div>
        </div>
        <div class="form-group">
          <label>Alamat</label>
          <textarea name="address" rows="2" placeholder="Alamat lengkap mitra"></textarea>
        </div>
        <button type="submit" class="btn-primary">Simpan Mitra</button>
      </form>
    </section>

    <section>
      <div class="mitra-actions-bar">
        <div class="search-box">
          <input type="text" id="mitraSearch" placeholder="Cari mitra..." />
        </div>
        <select id="mitraTypeFilter" class="filter-select">
          <option value="">Semua Jenis</option>
          <option value="klinik">Klinik</option>
          <option value="puskesmas">Puskesmas</option>
          <option value="rumah_sakit">Rumah Sakit</option>
        </select>
        <select id="mitraStatusFilter" class="filter-select">
          <option value="">Semua Status</option>
          <option value="active">Aktif</option>
          <option value="inactive">Tidak Aktif</option>
        </select>
      </div>

      <div class="partners-stats">
        <div class="stat-card"><div class="stat-number"><%= partners.length %></div><div class="stat-label">Total Mitra</div></div>
        <div class="stat-card"><div class="stat-number"><%= partners.filter(p=>p.is_active).length %></div><div class="stat-label">Aktif</div></div>
        <div class="stat-card"><div class="stat-number"><%= partners.filter(p=>!p.is_active).length %></div><div class="stat-label">Nonaktif</div></div>
        <div class="stat-card"><div class="stat-number"><%= partners.filter(p=>p.type==='klinik').length %></div><div class="stat-label">Klinik</div></div>
        <div class="stat-card"><div class="stat-number"><%= partners.filter(p=>p.type==='puskesmas').length %></div><div class="stat-label">Puskesmas</div></div>
        <div class="stat-card"><div class="stat-number"><%= partners.filter(p=>p.type==='rumah_sakit').length %></div><div class="stat-label">Rumah Sakit</div></div>
      </div>

      <table class="partners-table" id="mitraTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nama</th>
            <th>Jenis</th>
            <th>Kode</th>
            <th>Provinsi</th>
            <th>Protokol</th>
            <th>Status</th>
            <th>Dibuat</th>
          </tr>
        </thead>
        <tbody>
          <% partners.forEach(function(partner){ %>
            <tr class="mitra-row <%= partner.is_active ? 'active' : 'inactive' %>" data-type="<%= partner.type %>" data-status="<%= partner.is_active ? 'active' : 'inactive' %>" data-name="<%= partner.name.toLowerCase() %>">
              <td><%= partner.id %></td>
              <td>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 150px;">
                    <strong><%= partner.name %></strong>
                    <% if (partner.phone) { %><br><small>üìû <%= partner.phone %></small><% } %>
                    <% if (partner.email) { %><br><small>‚úâÔ∏è <%= partner.email %></small><% } %>
                  </div>
                  <div style="display: flex; gap: 6px; flex-shrink: 0;">
                    <% if (user.role === 'admin' || user.role === 'operator') { %>
                      <button type="button" class="btn-icon btn-edit" onclick="openEditModal(<%= partner.id %>, '<%= partner.name.replace(/'/g, "\\'") %>', '<%= partner.type %>', '<%= partner.code %>', '<%= partner.province_code %>', '<%= (partner.phone || '').replace(/'/g, "\\'") %>', '<%= (partner.email || '').replace(/'/g, "\\'") %>', '<%= (partner.address || '').replace(/'/g, "\\'").replace(/\n/g, ' ') %>')" title="Edit Mitra">
                        ‚úèÔ∏è
                      </button>
                    <% } %>
                    <% if (user.role === 'admin') { %>
                      <button type="button" class="btn-icon btn-delete" onclick="confirmDelete(<%= partner.id %>, '<%= partner.name.replace(/'/g, "\\'") %>', <%= partner.protocol_count || 0 %>)" title="Hapus Mitra">
                        üóëÔ∏è
                      </button>
                    <% } %>
                  </div>
                </div>
              </td>
              <td><span class="type-badge"><%= partner.type.replace('_',' ').toUpperCase() %></span></td>
              <td><code><%= partner.code %></code></td>
              <td><%= partner.province_code %></td>
              <td><span class="protocol-count"><%= partner.protocol_count || 0 %></span></td>
              <td><span class="status-badge <%= partner.is_active ? 'status-active':'status-inactive' %>"><%= partner.is_active ? 'Aktif':'Tidak Aktif' %></span></td>
              <td><%= new Date(partner.created_at).toLocaleDateString('id-ID') %><% if (partner.created_by_username) { %><br><small>by <%= partner.created_by_username %></small><% } %></td>
            </tr>
          <% }) %>
          <% if (partners.length === 0) { %>
            <tr><td colspan="8" class="no-data">Belum ada mitra.</td></tr>
          <% } %>
        </tbody>
      </table>
    </section>
  </div>

  <!-- Modal Edit Mitra -->
  <div id="editModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Mitra</h3>
        <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm" method="post">
        <input type="hidden" id="edit_id" name="id" />
        <div class="form-row">
          <div class="form-group">
            <label>Nama Mitra</label>
            <input type="text" id="edit_name" name="name" required />
          </div>
          <div class="form-group">
            <label>Jenis</label>
            <select id="edit_type" name="type" required>
              <option value="klinik">Klinik</option>
              <option value="puskesmas">Puskesmas</option>
              <option value="rumah_sakit">Rumah Sakit</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Kode Mitra</label>
            <input type="text" id="edit_code" name="code" required maxlength="10" />
          </div>
          <div class="form-group">
            <label>Provinsi</label>
            <select id="edit_province" name="province_code" required>
              <% provinces.forEach(function(p){ %>
                <option value="<%= p.code %>"><%= p.name %> (<%= p.code %>)</option>
              <% }) %>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Telepon</label>
            <input type="tel" id="edit_phone" name="phone" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="edit_email" name="email" />
          </div>
        </div>
        <div class="form-group">
          <label>Alamat</label>
          <textarea id="edit_address" name="address" rows="2"></textarea>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
          <button type="button" class="btn-secondary" onclick="closeEditModal()">Batal</button>
          <button type="submit" class="btn-primary">Simpan Perubahan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Konfirmasi Delete -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Konfirmasi Hapus</h3>
        <button type="button" class="modal-close" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div style="text-align: center; padding: 20px 10px;">
        <div style="font-size: 48px; color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è</div>
        <h3 style="margin: 0 0 15px 0; color: #333;">Hapus Mitra?</h3>
        <p style="color: #666; margin: 10px 0;">Apakah Anda yakin ingin menghapus:</p>
        <p style="font-weight: bold; color: #106EBE; font-size: 18px; margin: 15px 0;" id="delete_partner_name"></p>
        <div id="protocol_warning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 10px; margin: 15px 0; color: #856404;">
          <strong>‚ö†Ô∏è Peringatan:</strong> Mitra ini memiliki <span id="protocol_count_text"></span> protokol terkait. Penghapusan tidak diizinkan.
        </div>
        <p id="delete_confirm_text" style="color: #666; margin: 10px 0;">Tindakan ini tidak dapat dibatalkan.</p>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px; border-top: 2px solid #F8BBD0;">
        <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Batal</button>
        <button type="button" class="btn-danger" id="confirmDeleteBtn" onclick="executeDelete()">Hapus Mitra</button>
      </div>
    </div>
  </div>

  <script src="/toast.js"></script>
  <script>
    const searchInput = document.getElementById('mitraSearch');
    const typeFilter = document.getElementById('mitraTypeFilter');
    const statusFilter = document.getElementById('mitraStatusFilter');
    const table = document.getElementById('mitraTable');
    let currentDeleteId = null;

    function applyFilters(){
      const nameQuery = searchInput.value.trim().toLowerCase();
      const typeVal = typeFilter.value;
      const statusVal = statusFilter.value;
      table.querySelectorAll('tbody tr.mitra-row').forEach(row => {
        const rowName = row.dataset.name;
        const rowType = row.dataset.type;
        const rowStatus = row.dataset.status;
        let visible = true;
        if (nameQuery && !rowName.includes(nameQuery)) visible = false;
        if (typeVal && rowType !== typeVal) visible = false;
        if (statusVal && rowStatus !== statusVal) visible = false;
        row.style.display = visible ? '' : 'none';
      });
    }

    [searchInput, typeFilter, statusFilter].forEach(el => el.addEventListener('input', applyFilters));

    function openEditModal(id, name, type, code, province, phone, email, address) {
      document.getElementById('edit_id').value = id;
      document.getElementById('edit_name').value = name;
      document.getElementById('edit_type').value = type;
      document.getElementById('edit_code').value = code;
      document.getElementById('edit_province').value = province;
      document.getElementById('edit_phone').value = phone;
      document.getElementById('edit_email').value = email;
      document.getElementById('edit_address').value = address;
      document.getElementById('editForm').action = '/partners/' + id + '/edit';
      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
    }

    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) closeEditModal();
    });

    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      
      fetch(this.action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) {
          showSuccessToast('Berhasil!', 'Mitra berhasil diperbarui');
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showErrorToast('Error!', resp.error || 'Gagal memperbarui mitra');
        }
      })
      .catch(err => {
        console.error(err);
        showErrorToast('Error!', err.message || 'Terjadi kesalahan');
      });
    });
    
    // Delete Modal Functions
    function confirmDelete(id, name, protocolCount) {
      currentDeleteId = id;
      document.getElementById('delete_partner_name').textContent = name;
      
      const protocolWarning = document.getElementById('protocol_warning');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      const confirmText = document.getElementById('delete_confirm_text');
      
      if (protocolCount > 0) {
        document.getElementById('protocol_count_text').textContent = protocolCount;
        protocolWarning.style.display = 'block';
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';
        confirmText.style.display = 'none';
      } else {
        protocolWarning.style.display = 'none';
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
        confirmText.style.display = 'block';
      }
      
      document.getElementById('deleteModal').classList.add('show');
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
      currentDeleteId = null;
    }
    
    function executeDelete() {
      if (!currentDeleteId) return;
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/partners/${currentDeleteId}/delete`;
      document.body.appendChild(form);
      form.submit();
    }
    
    // Close modals when clicking outside
    document.getElementById('deleteModal').addEventListener('click', function(e) {
      if (e.target === this) closeDeleteModal();
    });
    
    // Close modals with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeEditModal();
        closeDeleteModal();
      }
    });
  </script>
</body>
</html>
